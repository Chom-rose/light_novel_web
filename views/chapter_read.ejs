<%- include('includes/head') %>
</head>
<body>
  <%- include('includes/nav') %>

  <main id="chapterBox" class="max-w-3xl mx-auto p-6">
    <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô...</p>
  </main>

  <div class="max-w-3xl mx-auto p-6">
    <a href="/novel/<%= novelId %>" class="text-indigo-600 hover:underline">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");
      const novelId = "<%= novelId %>";
      const chapterId = "<%= chapterId %>";

      const box = document.getElementById("chapterBox");

      try {
        const res = await fetch(`/chapter/api/novels/${novelId}/chapters/${chapterId}`, {
          headers: token ? { "Authorization": "Bearer " + token } : {}
        });
        const data = await res.json();

        if (!res.ok || data.error) {
          box.innerHTML = `<p class="text-red-500">${data.error || "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"}</p>`;
          return;
        }

        if (Number(data.chapter.is_premium) === 1 && !data.canRead) {
          if (!data.user) {
            box.innerHTML = `<p class="text-gray-500">üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                             <a href="/login" class="text-indigo-600 hover:underline">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>`;
          } else {
            box.innerHTML = `<p class="text-gray-500">üîí ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                             <a href="/premium" class="text-indigo-600 hover:underline">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°</a>`;
          }
        } else {
          box.innerHTML = `<article class="prose max-w-none">${data.chapter.content}</article>`;
        }
      } catch (err) {
        box.innerHTML = `<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</p>`;
      }
    });
  </script>
  <script src="/js/main.js"></script>
</body>
</html>
